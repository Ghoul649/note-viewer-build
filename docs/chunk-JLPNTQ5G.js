import{b as bt,d as yt,f as wt}from"./chunk-XLPILHHZ.js";import{c as gt,e as ft,f as _t}from"./chunk-V4AKKYNH.js";import{$ as j,$a as ht,A as ot,Ba as v,Ca as b,Da as V,Ea as N,G as R,Ia as l,J as L,Ja as c,K as m,Ka as y,La as at,Ma as lt,Oa as I,P as u,Qa as p,R as rt,Ra as z,Sa as ct,Ta as pt,V as st,Va as O,W as f,Wa as D,X as _,Xa as F,Za as k,a as et,aa as H,b as it,bb as Q,cb as X,db as G,e as M,eb as dt,fb as g,g as nt,hb as mt,ja as d,ka as h,lb as ut,qa as E,sa as Y,wb as K,yb as S,za as x}from"./chunk-ONATRPPM.js";var Ct=(()=>{let i=class i{constructor(t,e,n){this._renderer=t,this._ref=e,this._cdRef=n,this.value=0,this.direction="horizontal",this.valueChange=new H,this.isDragging=!1,this._subscription=new M}ngOnDestroy(){this._subscription.unsubscribe(),this._tempSubscription?.unsubscribe()}ngOnInit(){}_updateValue(t){this.min!=null&&(t=Math.max(this.min,t)),this.max!=null&&(t=Math.min(this.max,t)),this.value!==t&&this.valueChange.next(t)}_onPointerDown(t){let e=this.value,n=this.direction==="horizontal"?t.x:t.y;this._tempSubscription?.unsubscribe(),this._tempSubscription=new M,this.isDragging=!0,t.target.setPointerCapture(t.pointerId);{let o=this._renderer.listen(t.target,"pointermove",a=>{let C=this.direction==="horizontal"?a.x:a.y;return this._updateValue(e+C-n),!1});this._tempSubscription.add(o)}{let o=this._renderer.listen(t.target,"pointerup",a=>{let C=this.direction==="horizontal"?a.x:a.y;return this._updateValue(e+C-n),this._tempSubscription?.unsubscribe(),t.target.releasePointerCapture(t.pointerId),this.isDragging=!1,this._cdRef.markForCheck(),!1});this._tempSubscription.add(o)}return!1}_onTouchStart(){return!1}};i.\u0275fac=function(e){return new(e||i)(h(E),h(j),h(ut))},i.\u0275dir=rt({type:i,selectors:[["app-resize-handle"],["","resizeHandle",""]],hostVars:2,hostBindings:function(e,n){e&1&&p("pointerdown",function(a){return n._onPointerDown(a)})("touchstart",function(){return n._onTouchStart()}),e&2&&V("dragging",n.isDragging)},inputs:{value:"value",min:"min",max:"max",direction:"direction"},outputs:{valueChange:"valueChange"},exportAs:["handle"],standalone:!0});let r=i;return r})();function Z(r,i,s){return Math.min(Math.max(r,i),s)}function T(r,i,s){return((255*Z(r,0,1)<<8)+255*Z(i,0,1)<<8)+255*Z(s,0,1)}var Vt=r=>Math.floor(r*255+(r*255<<8)+(r*255<<16)),Ot=r=>{let i=r*3;return i<1?T(0,0,i):i<2?T(0,i-1,2-i):T(i-2,3-i,0)},Dt=r=>{let i=r*4;return i<1?T(0,0,i):i<2?T(0,i-1,(3-i)*.5):i<3?T(i-2,(4-i)*.5,.5):T(1,(i-2)*.5,(i-2)*.5)},vt={blackAndWhite:Vt,gradientBGR:Ot,gradientBGRW:Dt};var q=class{constructor(i,s,t){this.length=i,this.height=s,this.data=t,this.changes=new nt}},U=class extends q{constructor(i,s){let t=i.analyzingSize;super(s,t,new Float32Array(s*t)),this.config=i}generateTestingData(){for(let i=0;i<this.height;i++)for(let s=0;s<this.length;s++){let t=Math.sin(s*.02)*.5+.5;this.data[s+i*this.length]=t}this.changes.next(new W(0,this.length))}insertData(i,s){let t=i.length/this.height;for(let e=0;e<this.height;e++)for(let n=0;n<t;n++)this.data[n+s+e*this.length]=i[n+e*t];this.changes.next(new W(s,s+t))}},J=class extends q{constructor(i,s){let t=i.analyzingSize;super(s,t,new Uint8ClampedArray(s*t*4)),this.config=i,this.colorFn=vt.gradientBGRW,this.mapFn=e=>(1-1/Math.pow(1e6,e))/.999999}renderSegment(i,s=0,t=this.length){for(let e=0;e<this.height;e++)for(let n=s;n<t;n++){let o=(n+e*this.length)*4,a=this.colorFn(this.mapFn(i.data[n+e*this.length]));this.data[o]=(a&16711680)>>16,this.data[o+1]=(a&65280)>>8,this.data[o+2]=a&255,this.data[o+3]=255}this.changes.next(new W(s,t))}},W=class{constructor(i,s){this.from=i,this.to=s}};var w=(()=>{let i=class i extends wt{constructor(t,e,n){super(e),this.buffer=t,this.options=e,this._zone=n,this.context=new window.AudioContext,this.analyzerState="initialized";let o=Math.ceil(t.length/this.tickLength);this.render=new J(this,o),this.data=new U(this,o),this.sampleRate=t.sampleRate,this.data.changes.subscribe(a=>{this.render.renderSegment(this.data,a.from,a.to)}),this._worker=this._initWorker()}ngOnDestroy(){this._worker.terminate()}_initWorker(){let t=new Worker(new URL("worker-F7H7DMIH.js",import.meta.url),{type:"module"});return t.addEventListener("message",e=>{switch(e.data.type){case"result":this.data.insertData(new Float32Array(e.data.output),e.data.start);break;case"state":let n=e.data.state;this._zone.run(()=>this.analyzerState=n);break}}),t.postMessage({sampleRate:this.sampleRate,cycles:this.cycles,points:this.points,tickLength:this.tickLength,tuning:this.tuning,type:"init",input:this.buffer.getChannelData(0).buffer}),t}startWorker(){if(this.analyzerState!=="initialized"&&this.analyzerState!=="suspended")throw new Error("Cannot resume analyzing");this._worker.postMessage({type:"start"})}suspendWorker(){if(this.analyzerState!=="analyzing")throw new Error("Cannot suspend the worker");this._worker.postMessage({type:"suspend"})}};i.\u0275fac=function(e){return new(e||i)(L(AudioBuffer),L(yt),L(Y))},i.\u0275prov=R({token:i,factory:i.\u0275fac});let r=i;return r})();var Tt=["*"];function Et(r,i){if(r&1&&(at(0),l(1,"div",1),k(2),c(),y(3,"div",2),lt()),r&2){let s=i.$implicit,t=i.index,e=z();d(),b("height",e.keyHeight*e.viewport.zoomY,"px"),V("black",s.isBlack),d(),ht(" ",e.keyHeight*e.viewport.zoomY>8?s.name:""," "),d(),b("height",e.keyHeight*e.viewport.zoomY,"px")("top",e.keyHeight*t*e.viewport.zoomY,"px"),V("black",s.isBlack)("dividing",s.baseNote==="C"||s.baseNote==="F")}}var kt=(()=>{let i=class i{constructor(t,e){this.viewport=t,this.service=e,this.trackBy=(n,o)=>o.index,this.keyHeight=A}};i.\u0275fac=function(e){return new(e||i)(h(B),h(w))},i.\u0275cmp=u({type:i,selectors:[["app-keyboard"]],standalone:!0,features:[g],ngContentSelectors:Tt,decls:2,vars:2,consts:[[4,"ngFor","ngForOf","ngForTrackBy"],[1,"key"],[1,"highlighter"]],template:function(e,n){e&1&&(ct(),x(0,Et,4,13,"ng-container",0),pt(1)),e&2&&v("ngForOf",n.service.notes)("ngForTrackBy",n.trackBy)},dependencies:[S,K],styles:["[_nghost-%COMP%]{position:relative;display:block;border-style:solid;border-color:#000;border-width:0px 1px;box-sizing:border-box}.key[_ngcontent-%COMP%]{-webkit-user-select:none;user-select:none;overflow:hidden;font-size:8px;box-sizing:border-box;border:2px outset rgba(0,0,0,.3333333333);border-top-color:#fff9;border-left:none;background-color:#aaa;color:#222}.key.black[_ngcontent-%COMP%]{background-color:#222;color:#aaa}.highlighter[_ngcontent-%COMP%]{position:absolute;left:0;width:100vw;box-sizing:border-box}.highlighter[_ngcontent-%COMP%]:not(.black){background-color:var(--white-key-bg, rgba(255, 255, 255, .0666666667))}.highlighter[_ngcontent-%COMP%]:hover{background-color:var(--selected-key-bg, rgba(255, 255, 255, .1333333333));-webkit-backdrop-filter:brightness(3);backdrop-filter:brightness(3)}.highlighter.dividing[_ngcontent-%COMP%]{border-bottom:2px solid var(--key-divider-bg, rgba(255, 255, 255, .1333333333))}"]});let r=i;return r})();var Bt=["canvas"];function Ht(r,i){if(r&1&&y(0,"canvas",2,0),r&2){let s=i.index,t=z();b("width",t.blockWidth*t.viewport.zoomX,"px")("height",t.blockHeight*t.viewport.zoomY,"px")("left",s*t.blockWidth*t.viewport.zoomX,"px"),v("width",t.blockLength)("height",t.blockVerticalLength)}}var zt=(()=>{let i=class i{constructor(t,e){this._service=t,this.viewport=e,this.contexts=[],this.blocksCount=0,this.blockLength=0,this.blockWidth=0,this.blocks=[],this.blockVerticalLength=0,this.blockHeight=0,this._subscription=new M,this.renderedData=new ImageData(t.render.data,t.render.length,t.render.height),this.blockVerticalLength=t.render.height,this.blockHeight=t.count*A,this.blockLength=128,this.blockWidth=this.blockLength*t.tickLength/t.sampleRate*St,this.blocksCount=Math.ceil(t.render.length/this.blockLength);let n=[];for(let o=0;o<this.blocksCount;o++)n[o]={};this.blocks=n,this._dataChangesSubscription=t.render.changes.subscribe(o=>{this.drawArea(o.from,o.to)})}ngOnInit(){}ngOnDestroy(){this._subscription.unsubscribe(),this._dataChangesSubscription?.unsubscribe()}ngAfterViewInit(){let t=this.canvases.changes.pipe(ot(!0)).subscribe(()=>{this.contexts=this.canvases.map(e=>e.nativeElement.getContext("2d"))});this._subscription.add(t)}_drawBlock(t,e,n){this.contexts[t].putImageData(this.renderedData,-this.blockLength*t,0,e,0,n,this.blockVerticalLength)}drawArea(t=0,e=this.renderedData.width){let n=Math.floor(t/this.blockLength);for(;t<e;){let o=(n+1)*this.blockLength;if(e<o){this._drawBlock(n,t,e-t);break}this._drawBlock(n,t,o-t),t=o,n++}}};i.\u0275fac=function(e){return new(e||i)(h(w),h(B))},i.\u0275cmp=u({type:i,selectors:[["app-spectrogram-renderer"]],viewQuery:function(e,n){if(e&1&&O(Bt,5),e&2){let o;D(o=F())&&(n.canvases=o)}},standalone:!0,features:[g],decls:1,vars:1,consts:[["canvas",""],[3,"width","height","left",4,"ngFor","ngForOf"],[3,"width","height"]],template:function(e,n){e&1&&x(0,Ht,2,8,"canvas",1),e&2&&v("ngForOf",n.blocks)},dependencies:[S,K],styles:["canvas[_ngcontent-%COMP%]{position:absolute;image-rendering:pixelated}"]});let r=i;return r})();var It=["scrollContainer"];function Wt(r,i){if(r&1){let s=I();l(0,"button",12),p("click",function(){f(s);let e=z();return _(e.service.startWorker())}),l(1,"span",13),k(2,"troubleshoot"),c()()}}function At(r,i){if(r&1){let s=I();l(0,"button",14),p("click",function(){f(s);let e=z();return _(e.service.suspendWorker())}),l(1,"span",13),k(2,"settings"),c()()}}function Rt(r,i){if(r&1){let s=I();l(0,"button",15),p("click",function(){f(s);let e=z();return _(e.service.startWorker())}),l(1,"span",13),k(2,"troubleshoot"),c()()}}var A=12,St=256,B=(()=>{let i=class i{get zoomY(){return this._zoomY}set zoomY(t){t=Math.min(Math.max(t,.5),8),this._zoomY=t,localStorage.setItem("zoomY",t.toString())}get zoomX(){return this._zoomX}set zoomX(t){t=Math.min(Math.max(t,.0625),16),this._zoomX=t,localStorage.setItem("zoomX",t.toString())}constructor(t){this.service=t,this._zoomY=+(localStorage.getItem("zoomY")??"1"),this._zoomX=+(localStorage.getItem("zoomX")??"1"),this.noteHeight=A,this.keyboardWidth=100,this.previewResize=null}ngOnInit(){}ngOnDestroy(){}onWheel(t){if(!t.ctrlKey&&!t.altKey)return;t.stopPropagation(),t.preventDefault();let e=t.deltaY/400;this.zoom(t.altKey?e:0,t.ctrlKey?e:0)}zoom(t,e){let n=this.scrollContainer.nativeElement;{t=Math.pow(2,-t);let o=this.zoomX;this.zoomX*=t,n.scrollLeft*=this.zoomX/o}{e=Math.pow(2,-e);let o=this.zoomY;this.zoomY*=e,n.scrollTop*=this.zoomY/o}}};i.\u0275fac=function(e){return new(e||i)(h(w))},i.\u0275cmp=u({type:i,selectors:[["app-viewport"]],viewQuery:function(e,n){if(e&1&&O(It,7),e&2){let o;D(o=F())&&(n.scrollContainer=o.first)}},standalone:!0,features:[g],decls:14,vars:10,consts:[["scrollContainer",""],[1,"scroll-container",3,"wheel"],[1,"scrollable-content"],[3,"valueChange","value","min","max"],[1,"icon-button","large","centered-item","floating-btn"],[1,"icon-button","rotating-animation","large","floating-btn","at-right-corner"],[1,"icon-button","large","floating-btn","at-right-corner"],["path","view/zoom/zoom_in_x",3,"click"],["path","view/zoom/zoom_out_x",3,"click"],["path","view/zoom/zoom_in_y",3,"click"],["path","view/zoom/zoom_out_y",3,"click"],["path","view/zoom/reset",3,"click"],[1,"icon-button","large","centered-item","floating-btn",3,"click"],[1,"mat-icon"],[1,"icon-button","rotating-animation","large","floating-btn","at-right-corner",3,"click"],[1,"icon-button","large","floating-btn","at-right-corner",3,"click"]],template:function(e,n){if(e&1){let o=I();l(0,"div",1,0),p("wheel",function(C){return f(o),_(n.onWheel(C))}),l(2,"div",2),y(3,"app-spectrogram-renderer"),c(),l(4,"app-keyboard")(5,"app-resize-handle",3),G("valueChange",function(C){return f(o),X(n.keyboardWidth,C)||(n.keyboardWidth=C),_(C)}),c()()(),x(6,Wt,3,0,"button",4)(7,At,3,0,"button",5)(8,Rt,3,0,"button",6),l(9,"app-toolbar-action",7),p("click",function(){return f(o),_(n.zoom(1,0))}),c(),l(10,"app-toolbar-action",8),p("click",function(){return f(o),_(n.zoom(-1,0))}),c(),l(11,"app-toolbar-action",9),p("click",function(){return f(o),_(n.zoom(0,1))}),c(),l(12,"app-toolbar-action",10),p("click",function(){return f(o),_(n.zoom(0,-1))}),c(),l(13,"app-toolbar-action",11),p("click",function(){return f(o),n.zoomX=1,_(n.zoomY=1)}),c()}if(e&2){let o;d(2),b("height",n.service.count*n.noteHeight*n.zoomY)("left",n.keyboardWidth,"px"),d(2),b("width",n.keyboardWidth,"px"),d(),Q("value",n.keyboardWidth),v("min",20)("max",200),d(),N((o=n.service.analyzerState)==="initialized"?6:o==="analyzing"?7:o==="suspended"?8:-1)}},dependencies:[S,kt,zt,Ct,bt],styles:["[_nghost-%COMP%]{display:block;position:relative;background-color:#000}.scroll-container[_ngcontent-%COMP%]{overflow:scroll;position:absolute;inset:0}.scrollable-content[_ngcontent-%COMP%]{position:absolute;top:0}app-keyboard[_ngcontent-%COMP%]{position:sticky;left:0}app-resize-handle[_ngcontent-%COMP%]{display:block;cursor:e-resize;position:absolute;top:0;bottom:0;right:0;translate:50% 0;border-right-style:solid;border-right-width:5px;border-color:#0000}app-resize-handle[_ngcontent-%COMP%]:hover{border-color:#fff2}app-resize-handle.dragging[_ngcontent-%COMP%]{border-color:#fff9}.floating-btn[_ngcontent-%COMP%]{position:absolute;z-index:2}.at-right-corner[_ngcontent-%COMP%]{top:16px;right:32px}"]});let r=i;return r})();var Lt=["handle"],jt=["progressDiv"],Pt=(()=>{let i=class i{constructor(t,e){this._ref=t,this._renderer=e,this.value=0,this.valueChange=new H,this.released=new H,this.max=100,this.min=0,this.animate=null,this._animation=m(_t).build(gt("{{duration}}s",ft({width:"{{to}}%"}))),this.isDragging=!1}ngOnChanges(t){t.animate&&(this.animate?this._startAnimation():this._animationPlayer&&this._stopAnimation())}_startAnimation(){this.animate&&(this._stopAnimation(),this._animationPlayer=this._animation.create(this.progressDiv.nativeElement,{params:it(et({},this.animate),{to:100*(this.animate.to-this.min)/(this.max-this.min)})}),this._animationPlayer.play())}_stopAnimation(){this._animationPlayer&&(this._animationPlayer.destroy(),delete this._animationPlayer)}_getValue(t,e,n){let o=t.offsetX;return t.target===n&&(o+=n.offsetLeft+n.clientLeft/2-e.offsetLeft),o/=e.scrollWidth,o>1&&(o=1),o<0&&(o=0),o*(this.max-this.min)}_changeValue(t){this.value!==t&&(this.value=t,this.valueChange.emit(t))}onTrackClicked(t){let e=this._ref.nativeElement,n=this.handle.nativeElement;this._changeValue(this._getValue(t,e,n)),e.setPointerCapture(t.pointerId),this.isDragging=!0,this._subscription?.unsubscribe(),this._subscription=new M;{let o=this._renderer.listen(e,"pointerup",a=>(this._subscription.unsubscribe(),delete this._subscription,this.isDragging=!1,this._changeValue(this._getValue(a,e,n)),this.released.emit(),!1));this._subscription.add(o)}{let o=this._renderer.listen(e,"pointermove",a=>(this._changeValue(this._getValue(a,e,n)),!1));this._subscription.add(o)}return!1}onTouchStart(){return!1}};i.\u0275fac=function(e){return new(e||i)(h(j),h(E))},i.\u0275cmp=u({type:i,selectors:[["app-slider"]],viewQuery:function(e,n){if(e&1&&(O(Lt,7),O(jt,7)),e&2){let o;D(o=F())&&(n.handle=o.first),D(o=F())&&(n.progressDiv=o.first)}},hostBindings:function(e,n){e&1&&p("pointerdown",function(a){return n.onTrackClicked(a)})("touchstart",function(){return n.onTouchStart()})},inputs:{value:"value",max:"max",min:"min",animate:"animate"},outputs:{valueChange:"valueChange",released:"released"},standalone:!0,features:[st,g],decls:4,vars:4,consts:[["progressDiv",""],["handle",""],[1,"filled"],[1,"handle"]],template:function(e,n){e&1&&y(0,"div",2,0)(2,"div",3,1),e&2&&(b("width",100*(n.value-n.min)/(n.max-n.min),"%"),d(2),V("dragging",n.isDragging))},styles:[".filled[_ngcontent-%COMP%], .handle[_ngcontent-%COMP%], [_nghost-%COMP%]{height:0}.filled[_ngcontent-%COMP%], [_nghost-%COMP%]{border-style:solid;border-width:var(--slider-thickness, 8px);border-radius:var(--slider-thickness, 8px);margin:calc(var(--slider-thickness, 8px) * -1)}.filled[_ngcontent-%COMP%], .handle[_ngcontent-%COMP%]{border-color:var(--slider-color, red);background-color:var(--slider-color, red)}[_nghost-%COMP%]{border-color:#333;background-color:#333;cursor:pointer;display:flex;margin:0}.handle[_ngcontent-%COMP%]{border-style:solid;border-width:var(--handle-thickness, 14px);border-radius:var(--handle-thickness, 14px);margin:calc(var(--handle-thickness, 14px) * -1);opacity:0}.handle[_ngcontent-%COMP%]:hover{opacity:.2}.handle.dragging[_ngcontent-%COMP%]{opacity:.5}"]});let r=i;return r})();var $=(()=>{let i=class i{constructor(){this._context=m(AudioContext),this._buffer=m(AudioBuffer),this._zone=m(Y),this.state="Stopped",this.storedPosition=0,this.animationDuration=1,this.duration=this._buffer.duration}play(){this.stop(),this._source=this._context.createBufferSource(),this._source.buffer=this._buffer,this._source.onended=()=>{this._zone.run(()=>{this.state="Stopped"})},this.animationDuration=this._buffer.duration-this.storedPosition,this._source.connect(this._context.destination),this._source.start(0,this.storedPosition),this.state="Playing"}stop(){this._source&&(this._source.disconnect(),delete this._source),this.state="Stopped"}};i.\u0275fac=function(e){return new(e||i)},i.\u0275prov=R({token:i,factory:i.\u0275fac});let r=i;return r})();var Yt=(r,i)=>({to:r,duration:i});function Nt(r,i){r&1&&(l(0,"span",1),k(1,"play_arrow"),c())}function Qt(r,i){r&1&&(l(0,"span",1),k(1,"stop"),c())}var Mt=(()=>{let i=class i{constructor(){this.player=m($)}};i.\u0275fac=function(e){return new(e||i)},i.\u0275cmp=u({type:i,selectors:[["app-player-bar"]],hostAttrs:[1,"panel"],standalone:!0,features:[g],decls:4,vars:7,consts:[[1,"icon-button",3,"click"],[1,"mat-icon"],[3,"valueChange","released","value","max","animate"]],template:function(e,n){e&1&&(l(0,"button",0),p("click",function(){return n.player.state==="Stopped"?n.player.play():n.player.stop()}),x(1,Nt,2,0,"span",1)(2,Qt,2,0,"span",1),c(),l(3,"app-slider",2),G("valueChange",function(a){return X(n.player.storedPosition,a)||(n.player.storedPosition=a),a}),p("released",function(){return n.player.state==="Playing"&&n.player.play()}),c()),e&2&&(d(),N(n.player.state==="Stopped"?1:2),d(2),Q("value",n.player.storedPosition),v("max",n.player.duration)("animate",n.player.state==="Playing"?mt(4,Yt,n.player.duration,n.player.animationDuration):null))},dependencies:[Pt,S],styles:["[_nghost-%COMP%]{min-height:38px;display:flex;align-items:center}app-slider[_ngcontent-%COMP%]{margin:8px;flex:1 1}"]});let r=i;return r})();var Ze=(()=>{let i=class i{constructor(){this._service=m(w),this._renderer=m(E),this._renderer.listen(window,"beforeunload",t=>{t.preventDefault()})}ngOnDestroy(){}};i.\u0275fac=function(e){return new(e||i)},i.\u0275cmp=u({type:i,selectors:[["ng-component"]],standalone:!0,features:[dt([w,$,{provide:AudioContext,useFactory:()=>m(w).context}]),g],decls:2,vars:0,template:function(e,n){e&1&&y(0,"app-viewport")(1,"app-player-bar")},dependencies:[B,Mt],styles:["[_nghost-%COMP%]{display:grid;grid-template-rows:1fr auto;grid-template-columns:1fr auto;height:100%}app-viewport[_ngcontent-%COMP%]{position:relative;grid-row:1}app-main-toolbar[_ngcontent-%COMP%]{grid-row:1}app-player-bar[_ngcontent-%COMP%]{grid-row:3}.sidebar[_ngcontent-%COMP%]{grid-column:2;grid-row-start:1;grid-row-end:4}"]});let r=i;return r})();export{Ze as AnalyzerComponent};
